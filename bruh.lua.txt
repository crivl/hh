--[[
    TerminalWare Premium - Fixed Version
    Features:
    - Visible UI with keybind controls
    - Working notifications
    - Silent Aim with crosshair targeting
    - Anti-Lock system
    - Aim Viewer beam
]]

-- =============================================
--                 UI Setup
-- =============================================
local function CreateWindow(title)
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Parent = game.CoreGui
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global

    local Frame = Instance.new("Frame")
    Frame.Parent = ScreenGui
    Frame.Size = UDim2.new(0, 300, 0, 320)
    Frame.Position = UDim2.new(0.5, -150, 0.5, -160)
    Frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    Frame.BorderSizePixel = 0
    Frame.Visible = false

    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 6)
    UICorner.Parent = Frame

    local Title = Instance.new("TextLabel")
    Title.Parent = Frame
    Title.Size = UDim2.new(1, 0, 0, 30)
    Title.Text = title
    Title.Font = Enum.Font.GothamBold
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.BackgroundColor3 = Color3.fromRGB(35, 35, 35)

    -- Added UI Elements
    local elements = {
        SilentAimToggle = Instance.new("TextButton"),
        AntiLockToggle = Instance.new("TextButton"),
        KeybindList = Instance.new("ScrollingFrame")
    }

    -- Silent Aim Toggle
    elements.SilentAimToggle.Size = UDim2.new(0.9, 0, 0, 30)
    elements.SilentAimToggle.Position = UDim2.new(0.05, 0, 0.1, 0)
    elements.SilentAimToggle.Text = "Silent Aim: OFF"
    elements.SilentAimToggle.Parent = Frame

    -- Anti-Lock Toggle
    elements.AntiLockToggle.Size = UDim2.new(0.9, 0, 0, 30)
    elements.AntiLockToggle.Position = UDim2.new(0.05, 0, 0.25, 0)
    elements.AntiLockToggle.Text = "Anti-Lock: OFF"
    elements.AntiLockToggle.Parent = Frame

    -- Keybind List
    elements.KeybindList.Size = UDim2.new(0.9, 0, 0.5, 0)
    elements.KeybindList.Position = UDim2.new(0.05, 0, 0.4, 0)
    elements.KeybindList.Parent = Frame

    return Frame, ScreenGui, elements
end

-- =============================================
--               Configuration
-- =============================================
getgenv().TerminalWare = {
    Settings = {
        Prediction = 0.12,
        MenuKeybind = "Insert",
        SilentAimKey = "P",
        SwitchTargetKey = "F",
        AntiLockKey = "X",
        Enabled = false,
        AntiLock = false,
        CurrentTarget = nil,
        AimBeamColor = Color3.fromRGB(255, 85, 85)
    }
}

-- =============================================
--             Core Functionality
-- =============================================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera

-- Notification System Fix
local NotificationsGUI = Instance.new("ScreenGui")
NotificationsGUI.Parent = game.CoreGui

local function Notify(message, duration)
    local Notification = Instance.new("Frame")
    Notification.Parent = NotificationsGUI
    Notification.Size = UDim2.new(0, 250, 0, 30)
    Notification.Position = UDim2.new(0.02, 0, 0.4, 0)
    Notification.BackgroundTransparency = 0.3
    Notification.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    
    local Label = Instance.new("TextLabel")
    Label.Parent = Notification
    Label.Size = UDim2.new(1, 0, 1, 0)
    Label.Text = message
    Label.TextColor3 = Color3.fromRGB(255, 255, 255)
    Label.Font = Enum.Font.Gotham
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.Position = UDim2.new(0, 10, 0, 0)

    task.spawn(function()
        for i = 1, duration * 10 do
            Notification.BackgroundTransparency = 0.3 + (i/(duration * 10) * 0.7)
            Label.TextTransparency = i/(duration * 10)
            task.wait(0.1)
        end
        Notification:Destroy()
    end)
end

-- Target Finding Logic Fix
local function FindClosestToCrosshair()
    local closestPlayer, closestDistance = nil, math.huge
    local mousePos = Vector2.new(Mouse.X, Mouse.Y)
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local head = player.Character:FindFirstChild("Head")
            if head then
                local pos, onScreen = Camera:WorldToViewportPoint(head.Position)
                if onScreen then
                    local distance = (mousePos - Vector2.new(pos.X, pos.Y)).Magnitude
                    if distance < closestDistance then
                        closestDistance = distance
                        closestPlayer = player
                    end
                end
            end
        end
    end
    
    return closestPlayer
end

-- Working Anti-Lock System
local function VelocityChanger()
    if getgenv().TerminalWare.Settings.AntiLock then
        local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if root then
            root.Velocity = Vector3.new(
                math.random(-25, 25),
                root.Velocity.Y,
                math.random(-25, 25)
            )
        end
    end
end

-- Fixed Silent Aim Metatable Hook
local mt = getrawmetatable(game)
local oldIndex = mt.__index
setreadonly(mt, false)

mt.__index = newcclosure(function(self, key)
    if not checkcaller() and getgenv().TerminalWare.Settings.Enabled then
        if key == "Hit" and self:IsA("Mouse") then
            local target = FindClosestToCrosshair()
            if target and target.Character then
                local head = target.Character:FindFirstChild("Head")
                if head then
                    getgenv().TerminalWare.Settings.CurrentTarget = target
                    return CFrame.new(head.Position + (head.Velocity * getgenv().TerminalWare.Settings.Prediction))
                end
            end
        end
    end
    return oldIndex(self, key)
end)

setreadonly(mt, true)

-- =============================================
--               Input Handling
-- =============================================
local UIS = game:GetService("UserInputService")
local Window, MainUI, UIElements = CreateWindow("TerminalWare Premium")

-- Toggle UI Elements
UIElements.SilentAimToggle.MouseButton1Click:Connect(function()
    getgenv().TerminalWare.Settings.Enabled = not getgenv().TerminalWare.Settings.Enabled
    UIElements.SilentAimToggle.Text = "Silent Aim: "..(getgenv().TerminalWare.Settings.Enabled and "ON" or "OFF")
    Notify("Silent Aim: "..(getgenv().TerminalWare.Settings.Enabled and "ON" or "OFF"), 2)
end)

UIElements.AntiLockToggle.MouseButton1Click:Connect(function()
    getgenv().TerminalWare.Settings.AntiLock = not getgenv().TerminalWare.Settings.AntiLock
    UIElements.AntiLockToggle.Text = "Anti-Lock: "..(getgenv().TerminalWare.Settings.AntiLock and "ON" or "OFF")
    Notify("Anti-Lock: "..(getgenv().TerminalWare.Settings.AntiLock and "ON" or "OFF"), 2)
end)

UIS.InputBegan:Connect(function(input, processed)
    if processed then return end
    local key = input.KeyCode.Name
    
    -- Toggle Menu
    if key == getgenv().TerminalWare.Settings.MenuKeybind then
        Window.Visible = not Window.Visible
        Notify("Menu "..(Window.Visible and "Opened" or "Closed"), 2)
    end
    
    -- Silent Aim
    if key == getgenv().TerminalWare.Settings.SilentAimKey then
        getgenv().TerminalWare.Settings.Enabled = not getgenv().TerminalWare.Settings.Enabled
        UIElements.SilentAimToggle.Text = "Silent Aim: "..(getgenv().TerminalWare.Settings.Enabled and "ON" or "OFF")
        Notify("Silent Aim: "..(getgenv().TerminalWare.Settings.Enabled and "ON" or "OFF"), 2)
    end
    
    -- Switch Target
    if key == getgenv().TerminalWare.Settings.SwitchTargetKey then
        getgenv().TerminalWare.Settings.CurrentTarget = FindClosestToCrosshair()
        if getgenv().TerminalWare.Settings.CurrentTarget then
            Notify("Target: "..getgenv().TerminalWare.Settings.CurrentTarget.DisplayName, 2)
        end
    end
end)

-- =============================================
--                 Main Loop
-- =============================================
RunService.Stepped:Connect(VelocityChanger)

-- Initialization
Notify("TerminalWare Loaded - Press "..getgenv().TerminalWare.Settings.MenuKeybind.." to open menu", 5)
